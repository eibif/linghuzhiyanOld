# 软件详细设计说明书（结构版）

## Common模块

### config
- **AppConfig** - 应用基础配置
- **SwaggerConfig** - API文档配置
- **SecurityConfig** - 安全配置
- **RedisConfig** - Redis缓存配置
- **WebMvcConfig** - MVC相关配置

### constants
- **SystemConstants** - 系统级常量
- **ErrorCode** - 错误码枚举
- **RoleConstants** - 角色相关常量
- **ExperimentStatus** - 实验状态枚举
- **CacheConstants** - 缓存相关常量

### dto
- **Result** - 统一响应格式
- **PageResult** - 分页响应格式
- **LoginDTO** - 登录请求体
- **RegisterDTO** - 注册请求体  
- **IdDTO** - ID包装对象

### exception
- **BusinessException** - 业务异常基类
- **AuthException** - 认证异常
- **ParamException** - 参数异常
- **GlobalExceptionHandler** - 全局异常处理器

### security
- **JwtTokenProvider** - JWT令牌服务
- **AuthEntryPoint** - 认证入口点  
- **AccessDeniedHandler** - 权限拒绝处理器
- **UserDetailsServiceImpl** - 用户详情服务

### utils
- **JwtUtil** - JWT工具类
- **BeanUtil** - Bean操作工具
- **DateUtil** - 日期处理工具
- **EncryptUtil** - 加解密工具
- **FileUtil** - 文件操作工具

## Core模块
- **ExperimentCoreService** - 实验核心服务
- **UserCoreService** - 用户核心服务
- **EvaluationCoreService** - 评价核心服务
- **DiscussionCoreService** - 讨论核心服务

## User-Service模块

### api
- 以`/api/users`开头
```
POST /api/users/register        // 用户注册
{
    "username": "string", // 必填，用户名
    "email": "string",    // 必填，邮箱
    "password": "string", // 必填，密码
    "confirmPassword": "string", // 必填，确认密码
}

POST /api/users/login           // 用户登录
{
    "email": "string", // 必填，邮箱
    "password": "string", // 必填，密码
    "role": "string", // 必填，权限
}

GET /api/users/profile          // 获取用户个人资料

PUT /api/users/profile          // 更新用户个人资料
{
    "email": "string", // 可选，新邮箱
    "username": "string" // 可选，用户名
    "avatar": "string", // 可选，头像URL
    "profile": {
        "realName": "string", // 可选，真实姓名
        "gender": "string",   // 可选，性别
        "phone": "string",    // 可选，电话
        "education": "string", // 可选，学历
        "introduction": "string" // 可选，个人简介
        ……
  }
}
PUT /api/users/password         // 修改密码
{
    "currentPassword": "string", // 必填，当前密码
    "newPassword": "string",     // 必填，新密码
    "confirmPassword": "string"  // 必填，确认新密码
}
GET /api/users/{id}             // 获取指定用户信息
GET /api/users                  // 分页查询用户列表
```

### 数据表
```sql
-- 角色权限表
CREATE TABLE roles (
    id VARCHAR(20) PRIMARY KEY,
    name VARCHAR(50) NOT NULL UNIQUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- 用户表
CREATE TABLE users (
    id VARCHAR(36) PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(100) NOT NULL,
    avatar VARCHAR(255),
    profile JSON,               -- 存储个人资料（真实姓名、性别、电话等）
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    is_deleted BOOLEAN DEFAULT FALSE,
    INDEX idx_username (username),
    INDEX idx_email (email)
);

-- 关联表
CREATE TABLE user_roles (
    user_id VARCHAR(36) NOT NULL,
    role_id VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id),
    --FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    --FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_role_id (role_id)
);

-- 登录日志表
CREATE TABLE login_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(36) NOT NULL,
    ip_address VARCHAR(45) NOT NULL,                -- IP地址
    device_type VARCHAR(30),                        -- 设备类型：desktop, mobile, tablet
    status VARCHAR(20) NOT NULL,                    -- 登录状态：success, failed, blocked
    failure_reason VARCHAR(255),                    -- 失败原因（仅当失败时记录）
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    login_info JSON,                                -- 存储其他所有登录相关信息
    
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_status (status)
);
```
## Discussion-Service模块

### api
- **DiscussionController** - 讨论主题API  
```
POST /api/discussions               # 创建讨论
{
    String title;                  // 讨论标题
    String content;                // 讨论内容
    RichContentDTO richContent {   // 富文本内容
        String html;               // HTML格式内容
        Object delta;              // Quill/Draft.js Delta格式
    };
    List<String> tags;             // 标签列表
    String experimentId;           // 关联实验ID
    List<AttachmentDTO> attachments [  // 附件列表
        {
            String url;            // 附件URL
            String type;           // 类型: image, video, document 
            String name;           // 文件名
            Long size;             // 文件大小(bytes)
        }
    ];
}

# 获取讨论列表(带高级排序和过滤)
GET /api/discussions
可选参数:
  - tags: 标签过滤(逗号分隔)
  - experimentId: 实验ID过滤
  - userId: 用户ID过滤
  - status: 审核状态过滤(PENDING,REVIEW，APPROVED,REJECTED)
  - keyword: 关键词搜索
  - sortBy: 排序字段(createTime,lastActivityTime,likeCount,commentCount,viewCount)
  - order: 排序方向(asc,desc)
  - page: 页码
  - size: 每页大小

GET /api/discussions/{id}                       # 获取讨论详情

PUT /api/discussions/{id}                       # 更新讨论
请求体: {
    String title;                  // 更新的标题
    String content;                // 更新的内容
    RichContentDTO richContent;    // 富文本内容
    List<String> tags;             // 更新的标签
}

# 删除讨论
DELETE /api/discussions/{id}

PUT /api/discussions/{id}/review                # 讨论内容审核
请求体: {
    String status;                 // "APPROVED"或"REJECTED"
    String rejectionReason;        // 拒绝原因(如拒绝时必填)
}

PUT /api/discussions/{id}/priority              # 置顶/取消置顶讨论       
请求体: {
   Integer priority;   // 数值越大优先级越高
}

# 讨论点赞/取消点赞
POST /api/discussions/{id}/like
```
- **CommentController** - 评论API

```
POST /api/discussions/{discussionId}/comments              # 创建评论
{
    String content;                // 评论内容
    RichContentDTO richContent {   // 富文本内容
        String html;               // HTML格式
        Object delta;              // Delta格式
    };
    String parentId;               // 父评论ID
    String replyToUserId;          // 被回复用户ID
    List<AttachmentDTO> attachments [  // 附件列表
        {
            String url;            // 图片URL
            String type;           // 类型
            String thumbnailUrl;   // 缩略图URL
        }
    ];
}

GET /api/discussions/{discussionId}/comments               # 获取讨论的评论列表(带嵌套结构)
可选参数:
  - rootOnly: true/false (只返回顶级评论)
  - sortBy: createTime|likeCount
  - order: asc|desc
  - page: 页码
  - size: 每页大小

GET /api/comments/{commentId}/replies?page=1&size=10        # 获取评论的回复

DELETE /api/comments/{commentId}                            # 删除评论

POST /api/comments/{commentId}/like                         # 点赞/取消点赞评论

GET /api/comments/{commentId}                               # 获取评论详情

POST /api/comments/{commentId}/report                       # 举报评论
{
    String reason;                 // 举报原因
    String details;                // 详细描述
}

```

### 数据表
- **discussions** - 讨论主题表
- **comments** - 评论表
```sql
// discussions 集合
{
  "_id": "<ObjectId>",           // 讨论ID
  "title": "String",             // 讨论标题
  "content": "String",           // 讨论内容
  "richContent": {               // 富文本内容
    "html": "String",            // HTML格式内容
    "delta": Object              // Quill/Draft.js Delta格式
  },
  "userId": "String",            // 创建者ID
  "username": "String",          // 创建者用户名
  "userAvatar": "String",        // 用户头像URL
  "tags": ["String"],            // 标签列表
  "experimentId": "String",      // 关联实验ID (可选)
  "status": "String",            // 状态: PENDING, APPROVED, REJECTED
  "rejectionReason": "String",   // 拒绝原因(如有)
  "priority": NumberInt,         // 优先级(置顶用)
  "viewCount": NumberLong,       // 浏览次数
  "commentCount": NumberLong,    // 评论数量
  "likeCount": NumberLong,       // 点赞数量
  "likedBy": ["String"],         // 点赞用户ID列表
  "lastCommentTime": ISODate,    // 最后评论时间(用于热度排序)
  "lastActivityTime": ISODate,   // 最后活动时间
  "attachments": [{              // 附件列表
    "url": "String",             // 附件URL
    "type": "String",            // 类型: image, video, document, etc.
    "name": "String",            // 文件名
    "size": NumberLong           // 文件大小(bytes)
  }],
  "deleted": Boolean,            // 软删除标志
  "createTime": ISODate,         // 创建时间
  "updateTime": ISODate,         // 更新时间
  "approvedTime": ISODate,       // 审核通过时间
  "approvedBy": "String"         // 审核人ID
}

// comments 集合
{
  "_id": "<ObjectId>",           // 评论ID
  "discussionId": "String",      // 所属讨论ID
  "content": "String",           // 纯文本内容(用于搜索)
  "richContent": {               // 富文本内容
    "html": "String",            // HTML格式
    "delta": Object              // Delta格式
  },
  "userId": "String",            // 创建者ID
  "username": "String",          // 创建者用户名
  "userAvatar": "String",        // 用户头像URL
  "parentId": "String",          // 父评论ID
  "rootId": "String",            // 根评论ID(用于评论树)
  "path": "String",              // 评论路径(用于排序和查询)
  "depth": NumberInt,            // 评论深度
  "replyToUserId": "String",     // 回复目标用户ID
  "replyToUsername": "String",   // 回复目标用户名
  "likeCount": NumberInt,        // 点赞数
  "likedBy": ["String"],         // 点赞用户ID列表
  "attachments": [{              // 附件列表(图片等)
    "url": "String",
    "type": "String",
    "thumbnailUrl": "String"
  }],
  "status": "String",            // 状态: VISIBLE, HIDDEN, FLAGGED
  "deleted": Boolean,            // 软删除标志
  "createTime": ISODate,         // 创建时间
  "updateTime": ISODate          // 更新时间
}
// Discussion 索引
db.discussions.createIndex({ "userId": 1, "status": 1, "deleted": 1 });
db.discussions.createIndex({ "experimentId": 1, "status": 1, "deleted": 1 });
db.discussions.createIndex({ "tags": 1, "status": 1, "deleted": 1 });
db.discussions.createIndex({ "status": 1, "createTime": -1 });
db.discussions.createIndex({ "status": 1, "lastActivityTime": -1 });
db.discussions.createIndex({ "status": 1, "priority": -1, "lastActivityTime": -1 });
db.discussions.createIndex({ 
  "title": "text", 
  "content": "text" 
}, { 
  "weights": { 
    "title": 10, 
    "content": 5 
  },
  "default_language": "chinese" 
});

// Comment 索引
db.comments.createIndex({ "discussionId": 1, "deleted": 1, "createTime": -1 });
db.comments.createIndex({ "discussionId": 1, "rootId": 1, "path": 1 });
db.comments.createIndex({ "userId": 1, "deleted": 1 });
db.comments.createIndex({ "parentId": 1 });
db.comments.createIndex({ "content": "text" });
```

## Experiment-Service模块
## api
```
# 1. 实验管理
POST   /api/experiments                      // 创建新实验
GET    /api/experiments                      // 获取实验列表
GET    /api/experiments/{id}                 // 获取实验详情
PUT    /api/experiments/{id}                 // 更新实验
DELETE /api/experiments/{id}                 // 删除实验
PUT    /api/experiments/{id}/publish         // 发布实验
PUT    /api/experiments/{id}/unpublish       // 取消发布

# 2. 实验任务管理
POST   /api/experiments/{expId}/tasks        // 添加实验任务
GET    /api/experiments/{expId}/tasks        // 获取实验任务列表
GET    /api/tasks/{id}                       // 获取任务详情
PUT    /api/tasks/{id}                       // 更新任务
DELETE /api/tasks/{id}                       // 删除任务
PUT    /api/experiments/{expId}/tasks/order  // 调整任务顺序

# 3. 基础任务内容管理（选择/填空/问答）
POST   /api/tasks/{taskId}/basic             // 添加基础任务内容
GET    /api/tasks/{taskId}/basic             // 获取基础任务内容
PUT    /api/tasks/{taskId}/basic             // 更新基础任务内容

# 4. 代码任务管理
POST   /api/tasks/{taskId}/coding            // 添加代码任务内容
GET    /api/tasks/{taskId}/coding            // 获取代码任务内容
PUT    /api/tasks/{taskId}/coding            // 更新代码任务内容

# 5. 测试用例管理
POST   /api/tasks/{taskId}/testcases         // 添加测试用例
GET    /api/tasks/{taskId}/testcases         // 获取测试用例列表
GET    /api/testcases/{id}                   // 获取测试用例详情
PUT    /api/testcases/{id}                   // 更新测试用例
DELETE /api/testcases/{id}                   // 删除测试用例

# 6. 实验资源管理
POST   /api/experiments/{expId}/resources    // 上传实验资源
POST   /api/tasks/{taskId}/resources         // 上传任务资源
GET    /api/experiments/{expId}/resources    // 获取实验资源列表
GET    /api/tasks/{taskId}/resources         // 获取任务资源列表
GET    /api/resources/{id}                   // 获取资源详情
DELETE /api/resources/{id}                   // 删除资源

# 7. 实验分配管理
POST   /api/experiments/{expId}/assignments          // 分配实验给学生
POST   /api/experiments/{expId}/assignments/batch    // 批量分配实验
GET    /api/experiments/{expId}/assignments          // 获取实验分配列表
DELETE /api/experiments/{expId}/assignments/{userId} // 取消实验分配

# 8. 学生实验参与
GET    /api/student/experiments                      // 获取学生可访问实验
GET    /api/student/experiments/{expId}              // 获取学生实验详情
GET    /api/student/experiments/{expId}/tasks        // 获取实验任务列表
POST   /api/student/experiments/{expId}/start        // 开始实验
POST   /api/student/experiments/{expId}/submit       // 提交整个实验
GET    /api/student/experiments/{expId}/progress     // 获取实验进度
POST   /api/student/experiments/{expId}/resume       // 继续上次实验

# 9. 学生任务作答
GET    /api/student/tasks/{taskId}                   // 获取任务详情
POST   /api/student/tasks/{taskId}/save              // 保存任务进度
POST   /api/student/tasks/{taskId}/submit            // 提交任务答案

# 10. 基础题型作答
POST   /api/student/tasks/{taskId}/basic-answer      // 提交基础题型答案
PUT    /api/student/tasks/{taskId}/basic-answer      // 更新基础题型答案

# 11. 代码题作答
POST   /api/student/tasks/{taskId}/coding-answer     // 提交代码答案
PUT    /api/student/tasks/{taskId}/coding-answer     // 更新代码答案
POST   /api/student/tasks/{taskId}/execute           // 执行代码（预测试）

# 12. 自动评测
POST   /api/tasks/{taskId}/submissions/{subId}/grade // 自动评分
GET    /api/tasks/{taskId}/submissions/{subId}/results // 获取评测结果

# 13. 成绩与反馈
GET    /api/student/submissions/{subId}/feedback     // 获取提交反馈
GET    /api/student/tasks/{taskId}/submission/feedback // 获取任务反馈
GET    /api/student/experiments/{expId}/score        // 获取实验成绩

# 14. 实验历史记录
GET    /api/student/experiments/history              // 获取历史实验记录
GET    /api/student/experiments/{expId}/history      // 获取特定实验历史记录

# 15. 教师成绩管理
GET    /api/instructor/experiments/{expId}/submissions      // 获取所有学生提交
GET    /api/instructor/experiments/{expId}/students/{studentId}/submissions // 获取特定学生提交
PUT    /api/instructor/task-submissions/{subId}/grade       // 手动评分
PUT    /api/instructor/task-submissions/{subId}/feedback    // 提供反馈
```

## 数据表
```
experiment ─┬─→ experiment_task ─┬─→ experiment_task_basic
            │                     └─→ experiment_task_coding ───→ experiment_task_coding_testcase
            │
            └─→ experiment_resource
            │
            └─→ experiment_assignment
            │
            └─→ experiment_submission ─┬─→ experiment_task_submission ─┬─→ experiment_task_basic_answer
                                       │                               └─→ experiment_task_coding_answer ───→ experiment_task_coding_result
                                       └─→ experiment_resource
-- 保留原有的实验表，使用全大写枚举类型
create table experiment (
    id varchar(36) primary key,
    name varchar(100) not null,
    description text,
    creator_id varchar(36) not null,
    status enum('DRAFT', 'PUBLISHED') default 'DRAFT',
    start_time datetime not null,
    end_time datetime not null,
    max_attempts int default 1,
    is_template tinyint(1) default 0,
    created_at timestamp not null default current_timestamp,
    updated_at timestamp not null default current_timestamp on update current_timestamp
);

-- 通用实验任务表 - 不再包含题目具体内容
create table experiment_task (
    id varchar(36) primary key,
    experiment_id varchar(36) not null,
    title varchar(100) not null,
    description text,
    order_num int not null,
    task_type enum('CHOICE', 'FILL', 'QA', 'CODING') not null,
    required tinyint(1) default 1,
    max_score decimal(5,2) default 0,
    created_at timestamp not null default current_timestamp,
    updated_at timestamp not null default current_timestamp on update current_timestamp,
    foreign key (experiment_id) references experiment(id) on delete cascade
);

-- 三种基础题型的统一表 (选择题、填空题、问答题)
create table experiment_task_basic (
    task_id varchar(36) primary key,
    task_type enum('CHOICE', 'FILL', 'QA') not null,
    
    -- 选择题特有字段
    question_type enum('SINGLE', 'MULTIPLE') null,
    is_randomized tinyint(1) null,
    options json null,
    
    -- 填空题特有字段
    content text null,
    case_sensitive tinyint(1) null default 0,
    blanks json null,
    
    -- 问答题特有字段
    question text null,
    answer_type enum('SHORT', 'LONG', 'STRUCTURED') null,
    sample_answer text null,
    keywords json null,
    auto_gradable tinyint(1) null default 0,
    grading_criteria text null,
    
    foreign key (task_id) references experiment_task(id) on delete cascade
);

-- 代码题专用表（完全独立）
create table experiment_task_coding (
    task_id varchar(36) primary key,
    coding_type enum('FUNCTION', 'SCRIPT', 'PROJECT') not null,
    language varchar(30) not null,
    code_template text,
    function_signature varchar(255),
    time_limit int,
    memory_limit int,
    environment_config text,
    foreign key (task_id) references experiment_task(id) on delete cascade
);

create table experiment_task_coding_testcase (
    id varchar(36) primary key,
    task_id varchar(36) not null,
    input text,
    expected_output text,
    is_hidden tinyint(1) default 0,
    weight decimal(3,2) default 1.00,
    explanation text,
    foreign key (task_id) references experiment_task_coding(task_id) on delete cascade
);

-- 实验资源表
create table experiment_resource (
    id varchar(36) primary key,
    experiment_id varchar(36),
    task_id varchar(36),
    resource_type enum('DOCUMENT', 'IMAGE', 'VIDEO', 'CODE', 'OTHER') not null,
    resource_path varchar(255) not null,
    file_name varchar(100),
    file_size bigint,
    mime_type varchar(50),
    description text,
    upload_time timestamp not null default current_timestamp,
    foreign key (experiment_id) references experiment(id) on delete cascade,
    foreign key (task_id) references experiment_task(id) on delete cascade
);

-- 实验提交表 - 使用全大写枚举类型
create table experiment_submission (
    id varchar(36) primary key,
    experiment_id varchar(36) not null,
    student_id varchar(36) not null,
    status enum('IN_PROGRESS', 'SUBMITTED', 'GRADED', 'OVERDUE') not null,
    start_time timestamp not null default current_timestamp,
    submit_time timestamp null,
    current_task_id varchar(36),
    total_score decimal(5,2),
    feedback text,
    attempt_number int default 1,
    created_at timestamp not null default current_timestamp,
    updated_at timestamp not null default current_timestamp on update current_timestamp,
    foreign key (experiment_id) references experiment(id) on delete cascade,
    foreign key (current_task_id) references experiment_task(id) on delete set null
);

-- 任务提交表（通用）
create table experiment_task_submission (
    id varchar(36) primary key,
    submission_id varchar(36) not null,
    task_id varchar(36) not null,
    submit_time timestamp not null default current_timestamp,
    score decimal(5,2),
    feedback text,
    grader_id varchar(36),
    graded_time timestamp null,
    time_spent int,
    unique key (submission_id, task_id),
    foreign key (submission_id) references experiment_submission(id) on delete cascade,
    foreign key (task_id) references experiment_task(id) on delete cascade
);

-- 基础题型答案表（选择、填空、问答合并）
create table experiment_task_basic_answer (
    id varchar(36) primary key,
    task_submission_id varchar(36) not null,
    task_type enum('CHOICE', 'FILL', 'QA') not null,
    
    -- 选择题答案
    selected_options json null,
    
    -- 填空题答案
    fill_answers json null,
    
    -- 问答题答案
    text_answer text null,
    
    created_at timestamp not null default current_timestamp,
    foreign key (task_submission_id) references experiment_task_submission(id) on delete cascade
);

-- 代码题答案表（完全独立）e
create table experiment_task_coding_answer (
    task_submission_id varchar(36) primary key,
    code text not null,
    language varchar(30) not null,
    compile_status enum('PENDING', 'SUCCESS', 'ERROR') default 'PENDING',
    compile_message text,
    execution_time int,
    memory_used int,
    foreign key (task_submission_id) references experiment_task_submission(id) on delete cascade
);

create table experiment_task_coding_result (
    id varchar(36) primary key,
    task_submission_id varchar(36) not null,
    testcase_id varchar(36) not null,
    status enum('PENDING', 'ACCEPTED', 'WRONG_ANSWER', 'TIMEOUT', 'MEMORY_LIMIT', 'RUNTIME_ERROR') not null,
    execution_time int,
    memory_used int,
    output text,
    error_message text,
    unique key (task_submission_id, testcase_id),
    foreign key (task_submission_id) references experiment_task_coding_answer(task_submission_id) on delete cascade,
    foreign key (testcase_id) references experiment_task_coding_testcase(id) on delete cascade
);

-- 实验分配表
create table experiment_assignment (
    id varchar(36) primary key,
    task_id varchar(36) not null,
    user_id varchar(36) not null,
    assigned_at timestamp not null default current_timestamp,
    unique key uk_experiment_user (task_id, user_id),
    foreign key (task_id) references experiment_task(id) on delete cascade
);
```
## Support-Service模块

### api
- **FileController** - 文件管理API
- **ExportController** - 数据导出API  
- **SystemController** - 系统状态API
- **LogController** - 日志查询API

### 数据表
- **files** - 文件存储表
- **system_configs** - 系统配置表
- **export_tasks** - 导出任务表